apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow
name: Release with resuable workflows deployer
on:
  workflow_dispatch:
    inputs:
      manifest:
        type: string
        default: |
          [{"name":"MyAppAPIs","version":"2.0.5-0.0.17","workflow":"deploy.yaml"},{"name":"MyAppFE","version":"3.0.3-0.0.14","workflow":"deploy.yaml"},{"name":"MyAppBE","version":"2.2.0-0.0.21","workflow":"deploy.yaml"}]
jobs:
  pre-prod:
    steps:
      - name: Deploy all artifact versions
        uses: ./deployer.yaml
        with:
          manifest: ${{ inputs.manifest }}
          environment: pre-prod
  SRE:
    timeout-minutes: 4320
    delegates: cloudbees-io/manual-approval/custom-job.yml@v1
    needs: pre-prod
    with:
      approvers: ""
      disallowLaunchByUser: false
      instructions: Please approve for production deployment
  prod:
    needs:
      - SRE
    steps:
      - name: Deploy all artifact versions
        uses: ./deployer.yaml
        with:
          manifest: ${{ inputs.manifest }}
          environment: prod